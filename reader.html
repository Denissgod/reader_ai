<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Learning E-Book Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/epub.js/0.3.93/epub.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            
            --font-size-base: 14px;
            --font-size-sm: 12px;
            --font-size-lg: 16px;
            --font-size-xl: 18px;
            --font-size-2xl: 20px;
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --radius-base: 8px;
            --radius-lg: 12px;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: var(--color-teal-300);
                --color-primary-hover: var(--color-teal-400);
                --color-btn-primary-text: var(--color-slate-900);
                --color-border: rgba(167, 169, 169, 0.3);
            }
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
        }

        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-16);
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            gap: var(--space-16);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            flex: 1;
        }

        .header-title {
            margin: 0;
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            border: none;
            text-decoration: none;
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn:hover {
            background-color: var(--color-primary-hover);
        }

        .btn:active {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--color-surface);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background-color: var(--color-gray-200);
        }

        .btn-sm {
            padding: var(--space-4) var(--space-8);
            font-size: var(--font-size-sm);
        }

        .controls {
            display: flex;
            gap: var(--space-8);
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .control-group label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .slider {
            width: 100px;
            height: 4px;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: var(--color-border);
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--color-primary);
            cursor: pointer;
            border: none;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: var(--space-8);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: 500;
        }

        .toggle-switch {
            width: 40px;
            height: 24px;
            background-color: var(--color-border);
            border-radius: 12px;
            position: relative;
            transition: background-color 150ms ease;
        }

        .toggle-switch.active {
            background-color: var(--color-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 150ms ease;
        }

        .toggle-switch.active::after {
            left: 18px;
        }

        .api-key-wrapper {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }

        .api-key-input {
            padding: var(--space-8) var(--space-12);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            background-color: var(--color-surface);
            color: var(--color-text);
            font-size: var(--font-size-sm);
            width: 220px;
            transition: border-color 150ms ease;
        }

        .api-key-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .api-key-input::placeholder {
            color: var(--color-text-secondary);
        }

        .api-key-status {
            font-size: var(--font-size-base);
            cursor: help;
            title: 'API Key Status';
        }

        .github-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-base);
            color: var(--color-gray-400);
            text-decoration: none;
            transition: all 150ms ease;
            font-size: 18px;
            margin-left: var(--space-12);
        }

        .github-link:hover {
            color: var(--color-text);
            background-color: var(--color-secondary);
            transform: scale(1.1);
        }

        .github-link:active {
            transform: scale(0.95);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: var(--color-surface);
            border-right: 1px solid var(--color-border);
            padding: var(--space-16);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-16);
        }

        .sidebar-section h3 {
            margin: 0 0 var(--space-8) 0;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toc-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .toc-item {
            padding: var(--space-8) var(--space-12);
            background-color: var(--color-background);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: background-color 150ms ease;
            border: none;
            text-align: left;
            color: var(--color-text);
        }

        .toc-item:hover {
            background-color: var(--color-gray-200);
        }

        .toc-item.active {
            background-color: var(--color-primary);
            color: white;
        }

        .reader-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            flex-direction: column;
            color: var(--color-text-secondary);
            text-align: center;
            gap: var(--space-16);
        }

        .empty-state-icon {
            font-size: 48px;
            opacity: 0.3;
        }

        .empty-state p {
            margin: 0;
            max-width: 300px;
        }

        .reader-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-20);
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .reader-content {
            max-width: 700px;
            width: 100%;
            line-height: 1.8;
            font-size: var(--font-size-lg);
            text-align: justify;
        }

        .reader-content p {
            margin-bottom: var(--space-16);
        }

        .reader-content h1, .reader-content h2, .reader-content h3 {
            margin-top: var(--space-20);
            margin-bottom: var(--space-12);
        }

        .reader-content img {
            max-width: 100%;
            height: auto;
            margin: var(--space-16) 0;
        }

        .txt-reader {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .translation-popup {
            position: fixed;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-12);
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            backdrop-filter: blur(4px);
            animation: popupSlideIn 200ms ease;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .translation-popup.show {
            display: block;
        }

        .popup-word {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: var(--space-8);
            word-wrap: break-word;
        }

        .popup-ukrainian {
            font-size: var(--font-size-sm);
            color: var(--color-primary);
            font-weight: 600;
            margin-bottom: var(--space-12);
            padding-bottom: var(--space-12);
            border-bottom: 1px solid var(--color-border);
        }

        .popup-translation {
            font-size: var(--font-size-base);
            color: var(--color-text);
            margin-bottom: var(--space-12);
            padding-bottom: var(--space-12);
            border-bottom: 1px solid var(--color-border);
        }

        .popup-examples {
            display: flex;
            flex-direction: column;
            gap: var(--space-8);
        }

        .popup-example-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .popup-example {
            font-size: var(--font-size-sm);
            color: var(--color-text);
            padding: var(--space-8);
            background-color: var(--color-background);
            border-radius: var(--radius-base);
            line-height: 1.5;
            font-style: italic;
        }

        .popup-word-highlighted {
            font-weight: 600;
            color: var(--color-primary);
        }

        .close-popup {
            position: absolute;
            top: var(--space-8);
            right: var(--space-8);
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: var(--font-size-lg);
            transition: color 150ms ease;
        }

        .close-popup:hover {
            color: var(--color-text);
        }

        .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12) var(--space-16);
            background-color: var(--color-surface);
            border-top: 1px solid var(--color-border);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .pagination {
            display: flex;
            gap: var(--space-8);
            align-items: center;
        }

        .pagination button {
            padding: var(--space-4) var(--space-12);
            border: 1px solid var(--color-border);
            background-color: var(--color-surface);
            color: var(--color-text);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 150ms ease;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--color-primary);
            color: var(--color-btn-primary-text);
            border-color: var(--color-primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .hide-sidebar {
            display: none;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
                padding: var(--space-12);
            }

            .reader-wrapper {
                padding: var(--space-12);
            }

            .header {
                flex-wrap: wrap;
            }

            .controls {
                width: 100%;
                justify-content: space-between;
            }
        }

        .text-selection {
            position: relative;
            cursor: text;
            user-select: text;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1 class="header-title">üìö Language Reader</h1>
            <div class="file-input-wrapper">
                <button class="btn">Upload File</button>
                <input type="file" id="fileInput" accept=".epub,.txt,.pdf">
            </div>
            <div class="api-key-wrapper">
                <input type="password" id="apiKeyInput" class="api-key-input" placeholder="Enter OpenAI API Key">
                <span class="api-key-status" id="apiKeyStatus">üî¥</span>
                <a href="https://github.com/Denissgod/reader_ai" target="_blank" rel="noopener noreferrer" class="github-link" title="View on GitHub">
                    <i class="fab fa-github"></i>
                </a>
            </div>
        </div>
        <div class="controls">
            <div class="control-group">
                <label for="fontSizeSlider">Font:</label>
                <input type="range" id="fontSizeSlider" class="slider" min="12" max="24" value="16">
            </div>
            <div class="toggle">
                <span>Dark Mode</span>
                <div class="toggle-switch" id="darkModeToggle"></div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3>Contents</h3>
                <ul class="toc-list" id="tocList"></ul>
            </div>
        </div>

        <div class="reader-container">
            <div class="empty-state" id="emptyState">
                <div class="empty-state-icon">üìñ</div>
                <p>Upload an EPUB, TXT, or PDF file to start reading and learning.</p>
            </div>
            <div class="reader-wrapper" id="readerWrapper" style="display: none;">
                <div class="reader-content" id="readerContent" contenteditable="false"></div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div id="statusText">Ready</div>
        <div class="pagination">
            <button id="prevBtn" class="btn btn-secondary btn-sm" disabled>‚Üê Previous</button>
            <span id="pageInfo"></span>
            <button id="nextBtn" class="btn btn-secondary btn-sm" disabled>Next ‚Üí</button>
        </div>
    </div>

    <div class="translation-popup" id="translationPopup">
        <button class="close-popup" id="closePopup">‚úï</button>
        <div class="popup-word" id="popupWord"></div>
        <div class="popup-ukrainian" id="popupUkrainian"></div>
        <div class="popup-translation" id="popupTranslation"></div>
        <div class="popup-examples" id="popupExamples"></div>
    </div>

    <script>
        // ==================== SIMPLE MOCK DICTIONARY ====================
        const mockDictionary = {
            'the': 'def. art. - used to refer to something previously mentioned',
            'hello': 'n. - a polite word used when greeting someone',
            'world': 'n. - the earth and all the people, animals, plants, etc. on it',
            'book': 'n. - a set of written pages bound together',
            'read': 'v. - to look at and understand written words',
            'learn': 'v. - to acquire knowledge or skills',
            'language': 'n. - a system of communication using words',
            'beautiful': 'adj. - pleasing to look at or pleasant',
            'understand': 'v. - to know the meaning of something',
            'important': 'adj. - having great significance or value',
            'time': 'n. - the indefinite continued progress of existence',
            'good': 'adj. - of high quality; satisfactory',
            'people': 'n. - human beings in general',
            'life': 'n. - the condition of being alive',
            'day': 'n. - a period of 24 hours',
            'work': 'v./n. - activity involving effort; employment',
            'help': 'v. - to make something easier for someone',
            'word': 'n. - a single distinct meaningful element of speech',
            'example': 'n. - a thing characteristic of its kind',
            'sentence': 'n. - a set of words that makes complete sense',
        };

        // ==================== REAL OPENAI API INTEGRATION ====================
        async function fetchOpenAITranslation(word) {
            if (!openaiApiKey || openaiApiKey.trim().length === 0) {
                return {
                    ukrainian: '‚ùå Missing API Key',
                    translation: 'Please enter your OpenAI API Key in the header.',
                    examples: []
                };
            }

            try {
                const prompt = `Provide the translation and definition for the word '${word}'. Format the response exactly like this:
[UKRAINIAN_TRANSLATION]
[WORD] - [definition in English]
Examples:
[Sentence in a simple tense]
[Sentence in a continuous or perfect tense]
[A question or a negative sentence]`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a language learning assistant. Provide clear, concise translations and practical examples.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 300
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('OpenAI API Error:', error);
                    return {
                        ukrainian: '‚ùå API Error',
                        translation: error.error?.message || 'Failed to fetch translation. Check your API key.',
                        examples: []
                    };
                }

                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // Parse the response
                const lines = content.split('\n').filter(line => line.trim());
                let ukrainian = '';
                let translation = '';
                let examples = [];

                if (lines.length > 0) {
                    ukrainian = lines[0]; // First line is Ukrainian translation
                }
                if (lines.length > 1) {
                    translation = lines[1]; // Second line is definition
                }
                if (lines.length > 3) {
                    // Lines after "Examples:" are the example sentences
                    examples = lines.slice(3).filter(line => line.trim() && !line.toLowerCase().includes('examples'));
                }

                return { ukrainian, translation, examples };
            } catch (error) {
                console.error('Translation fetch error:', error);
                return {
                    ukrainian: '‚ùå Network Error',
                    translation: 'Failed to connect to OpenAI API. Check your internet connection.',
                    examples: []
                };
            }
        }

        // ==================== STATE MANAGEMENT ====================
        let currentBook = null;
        let currentFileType = null;
        let currentPageIndex = 0;
        let totalPages = 0;
        let isDarkMode = false;
        let fontSize = 16;
        let pdfDoc = null;
        let openaiApiKey = localStorage.getItem('openai_api_key') || '';

        // ==================== DOM ELEMENTS ====================
        const fileInput = document.getElementById('fileInput');
        const readerContent = document.getElementById('readerContent');
        const emptyState = document.getElementById('emptyState');
        const readerWrapper = document.getElementById('readerWrapper');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const translationPopup = document.getElementById('translationPopup');
        const popupWord = document.getElementById('popupWord');
        const popupUkrainian = document.getElementById('popupUkrainian');
        const popupTranslation = document.getElementById('popupTranslation');
        const popupExamples = document.getElementById('popupExamples');
        const closePopup = document.getElementById('closePopup');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        const tocList = document.getElementById('tocList');
        const statusText = document.getElementById('statusText');
        const sidebar = document.getElementById('sidebar');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeyStatus = document.getElementById('apiKeyStatus');

        // ==================== API KEY MANAGEMENT ====================
        function updateApiKeyStatus() {
            if (openaiApiKey && openaiApiKey.length > 0) {
                apiKeyStatus.textContent = 'üü¢';
                apiKeyStatus.title = 'API Key configured';
            } else {
                apiKeyStatus.textContent = 'üî¥';
                apiKeyStatus.title = 'API Key not set';
            }
        }

        apiKeyInput.value = openaiApiKey;
        updateApiKeyStatus();

        apiKeyInput.addEventListener('input', (e) => {
            openaiApiKey = e.target.value;
            localStorage.setItem('openai_api_key', openaiApiKey);
            updateApiKeyStatus();
        });

        // ==================== FONT SIZE CONTROL ====================
        fontSizeSlider.addEventListener('change', (e) => {
            fontSize = e.target.value;
            readerContent.style.fontSize = fontSize + 'px';
        });

        // ==================== DARK MODE TOGGLE ====================
        darkModeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            darkModeToggle.classList.toggle('active');
            document.documentElement.style.colorScheme = isDarkMode ? 'dark' : 'light';
        });

        // ==================== FILE UPLOAD ====================
        document.querySelector('.file-input-wrapper button').addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            statusText.textContent = 'Loading file...';
            const fileType = file.name.split('.').pop().toLowerCase();

            try {
                if (fileType === 'epub') {
                    await handleEpub(file);
                } else if (fileType === 'txt') {
                    await handleTxt(file);
                } else if (fileType === 'pdf') {
                    await handlePdf(file);
                } else {
                    statusText.textContent = 'File type not supported';
                }
            } catch (error) {
                console.error('Error loading file:', error);
                statusText.textContent = 'Error loading file';
            }
        });

        // ==================== EPUB HANDLING ====================
        async function handleEpub(file) {
            currentFileType = 'epub';
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    currentBook = ePub(event.target.result);
                    await currentBook.ready;
                    totalPages = currentBook.spine.spineItems.length;
                    currentPageIndex = 0;
                    
                    populateToc(currentBook.navigation.toc);
                    displayEpubPage();
                    
                    emptyState.style.display = 'none';
                    readerWrapper.style.display = 'flex';
                    prevBtn.disabled = true;
                    nextBtn.disabled = totalPages <= 1;
                    statusText.textContent = `EPUB loaded: ${totalPages} chapters`;
                } catch (error) {
                    console.error('EPUB error:', error);
                    statusText.textContent = 'Error loading EPUB';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function displayEpubPage() {
            if (!currentBook || currentPageIndex >= totalPages) return;
            
            try {
                const section = currentBook.spine.spineItems[currentPageIndex];
                const html = await section.load(currentBook.load.bind(currentBook));
                const text = html.textContent || '';
                readerContent.innerHTML = text;
                setupTextSelection();
                updatePagination();
                statusText.textContent = `Chapter ${currentPageIndex + 1} of ${totalPages}`;
            } catch (error) {
                console.error('Error displaying page:', error);
            }
        }

        function populateToc(tocItems) {
            tocList.innerHTML = '';
            tocItems.forEach((item, index) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'toc-item';
                button.textContent = item.label;
                button.addEventListener('click', () => {
                    currentPageIndex = index;
                    displayEpubPage();
                    document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                });
                li.appendChild(button);
                tocList.appendChild(li);
            });
        }

        // ==================== TXT HANDLING ====================
        async function handleTxt(file) {
            currentFileType = 'txt';
            const text = await file.text();
            const lines = text.split('\n').filter(line => line.trim());
            const chunkSize = 50;
            currentBook = [];
            
            for (let i = 0; i < lines.length; i += chunkSize) {
                currentBook.push(lines.slice(i, i + chunkSize).join('\n'));
            }
            
            totalPages = currentBook.length;
            currentPageIndex = 0;
            
            populateTxtToc();
            displayTxtPage();
            
            emptyState.style.display = 'none';
            readerWrapper.style.display = 'flex';
            prevBtn.disabled = true;
            nextBtn.disabled = totalPages <= 1;
            statusText.textContent = `Text loaded: ${totalPages} pages`;
        }

        function displayTxtPage() {
            if (!currentBook || currentPageIndex >= totalPages) return;
            readerContent.innerHTML = '';
            const pre = document.createElement('pre');
            pre.className = 'txt-reader';
            pre.textContent = currentBook[currentPageIndex];
            readerContent.appendChild(pre);
            setupTextSelection();
            updatePagination();
            statusText.textContent = `Page ${currentPageIndex + 1} of ${totalPages}`;
        }

        function populateTxtToc() {
            tocList.innerHTML = '';
            for (let i = 0; i < Math.min(totalPages, 20); i++) {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'toc-item';
                button.textContent = `Page ${i + 1}`;
                button.addEventListener('click', () => {
                    currentPageIndex = i;
                    displayTxtPage();
                    document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                });
                li.appendChild(button);
                tocList.appendChild(li);
            }
        }

        // ==================== PDF HANDLING ====================
        async function handlePdf(file) {
            currentFileType = 'pdf';
            pdfjsLib.getDocument(await file.arrayBuffer()).promise.then(pdf => {
                pdfDoc = pdf;
                totalPages = pdf.numPages;
                currentPageIndex = 0;
                
                populatePdfToc();
                displayPdfPage();
                
                emptyState.style.display = 'none';
                readerWrapper.style.display = 'flex';
                prevBtn.disabled = true;
                nextBtn.disabled = totalPages <= 1;
                statusText.textContent = `PDF loaded: ${totalPages} pages`;
            });
        }

        async function displayPdfPage() {
            if (!pdfDoc || currentPageIndex >= totalPages) return;
            
            const page = await pdfDoc.getPage(currentPageIndex + 1);
            const textContent = await page.getTextContent();
            readerContent.innerHTML = '';
            
            let currentLine = '';
            textContent.items.forEach(item => {
                currentLine += item.str + ' ';
                if (item.hasEOL) {
                    const p = document.createElement('p');
                    p.textContent = currentLine.trim();
                    readerContent.appendChild(p);
                    currentLine = '';
                }
            });
            
            if (currentLine.trim()) {
                const p = document.createElement('p');
                p.textContent = currentLine.trim();
                readerContent.appendChild(p);
            }
            
            setupTextSelection();
            updatePagination();
            statusText.textContent = `Page ${currentPageIndex + 1} of ${totalPages}`;
        }

        function populatePdfToc() {
            tocList.innerHTML = '';
            for (let i = 0; i < Math.min(totalPages, 1000); i++) {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'toc-item';
                button.textContent = `Page ${i + 1}`;
                button.addEventListener('click', () => {
                    currentPageIndex = i;
                    displayPdfPage();
                    document.querySelectorAll('.toc-item').forEach(el => el.classList.remove('active'));
                    button.classList.add('active');
                });
                li.appendChild(button);
                tocList.appendChild(li);
            }
        }

        // ==================== TEXT SELECTION & TRANSLATION ====================
        function setupTextSelection() {
            readerContent.addEventListener('mouseup', handleTextSelection);
        }

        async function handleTextSelection() {
            const selection = window.getSelection();
            if (!selection.toString().trim()) return;

            const word = selection.toString().trim().toLowerCase().replace(/[^\w-]/g, '');
            if (word.length === 0) return;

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            // Show loading state
            popupWord.textContent = word;
            popupUkrainian.textContent = '‚è≥ Loading...';
            popupTranslation.textContent = 'Fetching translation from OpenAI...';
            popupExamples.innerHTML = '';
            translationPopup.classList.add('show');
            translationPopup.style.left = (rect.left + rect.width / 2 - 175) + 'px';
            translationPopup.style.top = (rect.top - 10) + 'px';

            // Fetch real translation from OpenAI
            const result = await fetchOpenAITranslation(word);
            
            popupUkrainian.textContent = result.ukrainian;
            popupTranslation.textContent = result.translation;
            
            popupExamples.innerHTML = '<div class="popup-example-title">Examples:</div>';
            if (result.examples && result.examples.length > 0) {
                result.examples.forEach(example => {
                    const div = document.createElement('div');
                    div.className = 'popup-example';
                    div.innerHTML = example.replace(new RegExp(`\\b${word}\\b`, 'gi'), 
                        `<span class="popup-word-highlighted">$&</span>`);
                    popupExamples.appendChild(div);
                });
            } else {
                const noExamples = document.createElement('div');
                noExamples.className = 'popup-example';
                noExamples.textContent = 'No examples available.';
                popupExamples.appendChild(noExamples);
            }
        }

        closePopup.addEventListener('click', () => {
            translationPopup.classList.remove('show');
        });

        document.addEventListener('click', (e) => {
            if (!translationPopup.contains(e.target) && !readerContent.contains(e.target)) {
                translationPopup.classList.remove('show');
            }
        });

        // ==================== PAGINATION ====================
        prevBtn.addEventListener('click', () => {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                displayCurrentPage();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPageIndex < totalPages - 1) {
                currentPageIndex++;
                displayCurrentPage();
            }
        });

        function displayCurrentPage() {
            if (currentFileType === 'epub') displayEpubPage();
            else if (currentFileType === 'txt') displayTxtPage();
            else if (currentFileType === 'pdf') displayPdfPage();
            updatePagination();
        }

        function updatePagination() {
            pageInfo.textContent = `${currentPageIndex + 1} / ${totalPages}`;
            prevBtn.disabled = currentPageIndex === 0;
            nextBtn.disabled = currentPageIndex === totalPages - 1;
        }

        // ==================== INITIALIZATION ====================
        fontSizeSlider.value = fontSize;
        readerContent.style.fontSize = fontSize + 'px';
    </script>
</body>
</html>
